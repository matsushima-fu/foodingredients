# 食品成分データベースシステム 業務フロー図

## 1. 食品成分データベースの更新フロー

```mermaid
flowchart TD
    A[管理者] --> B[文部科学省の日本食品標準成分表2015年版（七訂）からExcelデータをダウンロード]
    B --> C[ダウンロードしたExcelデータをデータベース(食材)に投入]
    C --> D[ユーザーがデータベースの内容を閲覧・検索]
    D --> E{ユーザーが不足・誤りを発見?}
    E -->|はい| F[ユーザーが管理者に連絡]
    E -->|いいえ| D
    F --> G[管理者が連絡内容を確認]
    G --> H{連絡内容は正しい?}
    H -->|はい| I[データベース(食材)を修正]
    H -->|いいえ| J[ユーザーに説明]
    I --> D
    J --> D
    
    K[文部科学省の日本食品標準成分表が改定] --> L[新しくExcelデータを取得]
    L --> C
```

## 2. 献立の作成フロー

```mermaid
flowchart TD
    A[ユーザー] --> B[料理を作成]
    B --> C[データベース(料理履歴)に登録]
    C --> D[作成した料理に必要な食材をデータベース(食材)から選択]
    D --> E[1回の食事で複数の料理を献立として作成]
    E --> F[データベース(献立履歴)に登録]
    F --> G[メニューごと、献立ごとに必要な食材とカロリーを確認]
    G --> H[作成した献立・料理を履歴として呼び出し]
    H --> I{食材を変更する?}
    I -->|はい| J[履歴の食材を変更]
    I -->|いいえ| K[献立完了]
    J --> K
```

## 3. 食材の発注フロー

```mermaid
flowchart TD
    A[ユーザー] --> B[献立に必要な食材について発注]
    B --> C[作成する人数を入力]
    C --> D[必要な食材数を把握]
    D --> E{データベース(発注先)に発注先が存在?}
    E -->|はい| F[発注先を選択]
    E -->|いいえ| G[発注先を作成]
    G --> F
    F --> H[発注先に食材と食材数をセット]
    H --> I[発注書を作成]
    I --> J[発注書を印刷]
    J --> K[発注完了]
```

## 4. システム全体の統合フロー

```mermaid
flowchart TD
    A[管理者] --> B[食品成分データベース管理]
    A --> C[ユーザー連絡対応]
    
    D[ユーザー] --> E[データベース閲覧・検索]
    D --> F[献立作成]
    D --> G[食材発注]
    
    B --> H[食材データベース]
    C --> H
    E --> H
    F --> H
    G --> H
    
    F --> I[料理履歴データベース]
    F --> J[献立履歴データベース]
    G --> K[発注先データベース]
    
    L[文部科学省] --> M[日本食品標準成分表Excelデータ]
    M --> B
```

## 5. データベース構造

```mermaid
erDiagram
    食材 {
        int id PK
        string 食材名
        float カロリー
        float タンパク質
        float 脂質
        float 炭水化物
        string 分類
        string 備考
    }
    
    料理履歴 {
        int id PK
        string 料理名
        int ユーザーID FK
        datetime 作成日時
        string レシピ
    }
    
    料理食材 {
        int id PK
        int 料理ID FK
        int 食材ID FK
        float 使用量
        string 単位
    }
    
    献立履歴 {
        int id PK
        string 献立名
        int ユーザーID FK
        datetime 作成日時
        string メモ
    }
    
    献立料理 {
        int id PK
        int 献立ID FK
        int 料理ID FK
        int 順序
    }
    
    発注先 {
        int id PK
        string 発注先名
        string 住所
        string 電話番号
        string メールアドレス
    }
    
    発注履歴 {
        int id PK
        int ユーザーID FK
        int 発注先ID FK
        datetime 発注日時
        string 発注内容
        string ステータス
    }
    
    料理履歴 ||--o{ 料理食材 : "含む"
    食材 ||--o{ 料理食材 : "使用される"
    献立履歴 ||--o{ 献立料理 : "含む"
    料理履歴 ||--o{ 献立料理 : "献立に含まれる"
    発注先 ||--o{ 発注履歴 : "発注される"
```

## 6. ユーザー権限とアクセス制御

```mermaid
flowchart TD
    A[ユーザー] --> B[一般ユーザー]
    A --> C[管理者]
    
    B --> D[データベース閲覧・検索]
    B --> E[献立作成・編集]
    B --> F[食材発注]
    B --> G[管理者への連絡]
    
    C --> H[データベース更新]
    C --> I[ユーザー連絡対応]
    C --> J[発注先管理]
    C --> K[システム管理]
```

## 7. エラーハンドリングと例外処理

```mermaid
flowchart TD
    A[処理開始] --> B{データベース接続確認}
    B -->|成功| C[正常処理]
    B -->|失敗| D[エラーログ記録]
    D --> E[管理者に通知]
    E --> F[処理終了]
    
    C --> G{データ整合性チェック}
    G -->|正常| H[処理完了]
    G -->|異常| I[データ修正処理]
    I --> J[修正結果確認]
    J --> K{修正成功?}
    K -->|はい| H
    K -->|いいえ| L[手動修正要求]
    L --> F
```

## 8. システム監視とログ管理

```mermaid
flowchart TD
    A[システム監視] --> B[アクセスログ]
    A --> C[エラーログ]
    A --> D[パフォーマンスログ]
    
    B --> E[不正アクセス検知]
    C --> F[エラー分析]
    D --> G[パフォーマンス分析]
    
    E --> H[セキュリティ対策]
    F --> I[バグ修正]
    G --> J[最適化]
    
    H --> K[システム改善]
    I --> K
    J --> K
``` 